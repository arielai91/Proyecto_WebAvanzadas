services:
  # ──────────────────────────────────────────────
  # Infrastructure
  # ──────────────────────────────────────────────
  postgres:
    image: docker.io/library/postgres:16-alpine
    container_name: petfoundation-postgres
    environment:
      POSTGRES_DB: petfoundationdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgreSQL2025}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d petfoundationdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - petfoundation-net

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: petfoundation-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-guest}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - petfoundation-net

  # ──────────────────────────────────────────────
  # Backend Services
  # ──────────────────────────────────────────────
  rest-api:
    build:
      context: ./Backend
      dockerfile: Dockerfile.api
    container_name: petfoundation-rest-api
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:5001
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=petfoundationdb;Username=postgres;Password=${POSTGRES_PASSWORD:-postgreSQL2025}"
      Jwt__Key: ${JWT_KEY:-h2G8pF83mG93n1L0pZ0kC92fW2HkS5A1zY9cM0xV3tE8rU1wL3R9bP5hG6F2nD4yQ}
      Jwt__Issuer: ApiPetFoundation
      Jwt__Audience: ApiPetFoundationClient
      RabbitMq__HostName: rabbitmq
      RabbitMq__Port: 5672
      RabbitMq__UserName: ${RABBITMQ_DEFAULT_USER:-guest}
      RabbitMq__Password: ${RABBITMQ_DEFAULT_PASS:-guest}
      RabbitMq__ExchangeName: petfoundation.events
      Supabase__Url: ${SUPABASE_URL:-https://xkyicdwuczjmcpzxejje.supabase.co}
      Supabase__ServiceRoleKey: ${SUPABASE_SERVICE_ROLE_KEY:-}
      Supabase__Bucket: ${SUPABASE_BUCKET:-Pet}
      Seed__AdminEmail: ${Seed__AdminEmail:-admin@petfoundation.com}
      Seed__AdminPassword: ${Seed__AdminPassword:-Admin123!}
      Seed__AdminName: ${Seed__AdminName:-Administrator}
      Seed__UserEmail: ${Seed__UserEmail:-}
      Seed__UserPassword: ${Seed__UserPassword:-}
      Seed__UserName: ${Seed__UserName:-}
    ports:
      - "5001:5001"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5001/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - petfoundation-net

  soap-api:
    build:
      context: ./Backend
      dockerfile: Dockerfile.soap
    container_name: petfoundation-soap-api
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:5003
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=petfoundationdb;Username=postgres;Password=${POSTGRES_PASSWORD:-postgreSQL2025}"
      Jwt__Key: ${JWT_KEY:-h2G8pF83mG93n1L0pZ0kC92fW2HkS5A1zY9cM0xV3tE8rU1wL3R9bP5hG6F2nD4yQ}
      Jwt__Issuer: ApiPetFoundation
      Jwt__Audience: ApiPetFoundationClient
    ports:
      - "5003:5003"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5003/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - petfoundation-net

  notifications-api:
    build:
      context: ./Backend
      dockerfile: Dockerfile.notifications
    container_name: petfoundation-notifications-api
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:5004
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=petfoundationdb;Username=postgres;Password=${POSTGRES_PASSWORD:-postgreSQL2025}"
      Jwt__Key: ${JWT_KEY:-h2G8pF83mG93n1L0pZ0kC92fW2HkS5A1zY9cM0xV3tE8rU1wL3R9bP5hG6F2nD4yQ}
      Jwt__Issuer: ApiPetFoundation
      Jwt__Audience: ApiPetFoundationClient
      RabbitMq__HostName: rabbitmq
      RabbitMq__Port: 5672
      RabbitMq__UserName: ${RABBITMQ_DEFAULT_USER:-guest}
      RabbitMq__Password: ${RABBITMQ_DEFAULT_PASS:-guest}
      RabbitMq__ExchangeName: petfoundation.events
      RabbitMq__QueueName: notifications.pets
    ports:
      - "5004:5004"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5004/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - petfoundation-net

  api-gateway:
    build:
      context: ./Backend
      dockerfile: Dockerfile.gateway
    container_name: petfoundation-gateway
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:5000
      # Override YARP cluster destinations to use Docker service names (HTTP)
      ReverseProxy__Clusters__rest-cluster__Destinations__rest1__Address: http://rest-api:5001/
      ReverseProxy__Clusters__rest-cluster__HttpClient__DangerousAcceptAnyServerCertificate: "false"
      ReverseProxy__Clusters__soap-cluster__Destinations__soap1__Address: http://soap-api:5003/
      ReverseProxy__Clusters__soap-cluster__HttpClient__DangerousAcceptAnyServerCertificate: "false"
      ReverseProxy__Clusters__notifications-cluster__Destinations__notifications1__Address: http://notifications-api:5004/
      ReverseProxy__Clusters__notifications-cluster__HttpClient__DangerousAcceptAnyServerCertificate: "false"
    ports:
      - "5050:5000"
    depends_on:
      rest-api:
        condition: service_healthy
      soap-api:
        condition: service_healthy
      notifications-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - petfoundation-net

  # ──────────────────────────────────────────────
  # Frontend
  # ──────────────────────────────────────────────
  frontend:
    build:
      context: ./Proyecto-PetFoundation
      dockerfile: Dockerfile
      target: production
    container_name: petfoundation-frontend
    ports:
      - "8080:80"
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - petfoundation-net

volumes:
  postgres_data:
  rabbitmq_data:

networks:
  petfoundation-net:
    driver: bridge
